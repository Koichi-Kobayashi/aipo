#*
 * Aipo is a groupware program developed by TOWN, Inc.
 * Copyright (C) 2004-2015 TOWN, Inc.
 * http://www.aipo.com
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *#

## 参加ユーザーを表示するためのマクロ
#macro(draw_user $record)
<li id="messageRightUser_${record.userId}" class="messageRightUser">
<a href="javascript:void(0)" onclick="aipo.message.popupProfile(${record.UserId.Value},arguments[0])">
<span class="avatar"><img #if($!record.isHasPhoto())src="$!utils.escapeXML($jslink.getTemplate("FileuploadFacePhotoScreen").addQueryData("uid", $!record.UserId).addQueryData("t", "$!record.PhotoModified"))"#else src="themes/default/images/common/icon_user100.png"#end title="$!record.LastName $!record.FirstName" width="24" height="24" class="avatar_s"></span>
#if ($record.isOwner())
	<span class="admin">$l10n.MESSAGE_ROOM_ADMIN</span>
#end
<span class="name">${record.lastName} ${record.firstName}</span>
</a>
</li>
#end


#set($messagePortletId = $!globalPortlets.get('Message').getId())
#set($indicator_id = "indicator-dlg-")

#ALajaxIndicator("$indicator_id" "$!portlet.ID" "")


#if(${result.isNewRoom()})
## ルームがまだ作成されていない場合
## else以下は実行しない(if内で完結する)
## else以下と重複が大きいので直したほうが良いかもしれない
<div class="roomDetail">
<div class="clearfix">
	#foreach ($record in $result.List)
		<span class="avatar">
		#if("${record.userId}" != "${result.userId}")
			<img #if($!record.isHasPhoto())src="$!utils.escapeXML($jslink.getTemplate("FileuploadFacePhotoScreen").addQueryData("uid", $!record.UserId).addQueryData("t", "$!record.PhotoModified"))"#else src="themes/default/images/common/icon_user100.png"#end title="$!record.LastName $!record.FirstName" class="avatar_l">
		</span>
			<span class="name">${record.lastName} ${record.firstName}</span>
		#end
	#end
</div>
</div>
#else

<div class="roomDetail">
<div class="clearfix">
			<span class="avatar">
			#if(${result.RoomType} == "O") ##ダイレクトメッセージの場合
			#foreach ($record in $result.List)
				#if("${record.userId}" != "${result.userId}")
                <img #if($!record.isHasPhoto())src="$!utils.escapeXML($jslink.getTemplate("FileuploadFacePhotoScreen").addQueryData("uid", $!record.UserId).addQueryData("t", "$!record.PhotoModified"))"#else src="themes/default/images/common/icon_user100.png"#end title="$!record.LastName $!record.FirstName" class="avatar_l">
				#end
			#end
			#else ##グループの場合
			#if($!result.isHasPhotoRoom())
				<img src="$!utils.escapeXML($jslink.getTemplate("MessageFileuploadRoomPhotoScreen").addQueryData("rid", $!result.RoomId))" alt="$!result.RoomName"  class="avatar_l"/>
			#else
				<img src="themes/default/images/common/icon_group100.png" alt="$!result.RoomName" class="avatar_l"/>
			#end
			#end
			</span>
#if(${result.RoomType} == "O")
	#foreach ($record in $result.List)
		#if("${record.userId}" != "${result.userId}")
			<span class="name">${record.lastName} ${record.firstName}</span>
		#end
	#end
#else
<span class="name">${result.RoomName}</span>
#end
</div>
<div id="messageRoomSetting">
<a href="javascript:void(0)" id="menubar_button_$!{messagePortletId}" class="customizeMenuIcon menubarOpenButton" title="$l10n.MESSAGE_ROOM_SETTING" onclick="aipo.customize.showMenu('$messagePortletId');"><span class="auiWFicon"><i class="icon-cog"></i></span></a>
<div class="menubar body-child" id="menubar_$!{messagePortletId}" style="display: none; top: 20px; z-index: 9999">
<ul id="roomMemberAdmin">
#if(${result.isOwner()} && ${result.RoomType}=="G")
  <li>
  <a href="javascript:void(0)" onclick="aimluck.io.openDialog(this, '$!jslink.getPortletById($messagePortletId).addQueryData('template','MessageRoomFormScreen')&entityid=' + aipo.message.currentRoomId, '$messagePortletId', aipo.message.onLoadMessageRoomDialog);">$l10n.MESSAGE_ROOM_SETTING</a>
  </li>
#end
<li>
  <a href="javascript:void(0)" onclick="aimluck.io.openDialog(this, '$!jslink.getPortletById($messagePortletId).addQueryData('template','MessageRoomNotificationFormScreen')&entityid=' + aipo.message.currentRoomId, '$messagePortletId', aipo.message.onLoadMessageRoomDialog);">$l10n.MESSAGE_NOTIFICATION_SETTING</a>
</li>
<form style="display:inline" name="deleteForm_$!{portlet.ID}_$!{record.MessageId}" id="deleteForm_$!{portlet.ID}_$!{record.MessageId}" action="$!jslink.getPortletById($!portlet.ID).addQueryData('template','MessageFormJSONScreen')" method="post">
<input type="hidden" name="_name" value="$l10n.MESSAGE_ROOM" />
<input type="hidden" name="secid" value="$secid" />
#if(${result.isOwner()})
  <li>
  <a href="javascript:void(0)" onclick="aimluck.io.ajaxMessageRoomDeleteSubmission(dojo.byId('deleteForm_$!{portlet.ID}_$!{record.MessageId}'),'$!jslink.getPortletById($!portlet.ID).addQueryData('template','MessageRoomFormJSONScreen').addQueryData('mode', 'delete')&entityid=' + aipo.message.currentRoomId, '$indicator_id', '$messagePortletId', aipo.message.onReceiveMessageRoomDelete);">$l10n.COMMON_DELETE</a>
  </li>
#end
</form>
</ul>
</div>
</div>
</div>

<div class="roomDisc"></div>
<ul class="user" #if(${result.RoomType} == "O")style="display:none"#end>
<li class="index">$l10n.MESSAGE_ROOM_ENTRY_USER_ENG<span>${result.List.size()}人</span>
#if (${result.isOwner()})
##<a class="floatRight setting toggle" href="javascript:void(0)" title=$l10n.MESSAGE_ROOM_USER_SETTING onclick=""><i class="icon-cog"></i></a>
<a class="floatRight plus" href="javascript:void(0)"  title=$l10n.MESSAGE_USER_ADDING onclick="aimluck.io.openDialog(this, '$!jslink.getPortletById($messagePortletId).addQueryData('template','MessageRoomFormScreen')&entityid=' + aipo.message.currentRoomId, '$messagePortletId', aipo.message.onLoadMessageRoomDialog);"><i class="icon-plus"></i></a>
#end
</li>
#set ($member = [])
## ownerを先に表示するためにforeachを2回
## 一回目でownerのみを表示し、残りをmemberに
#foreach ($record in $result.List)
#if (${record.isOwner()})
	#draw_user($record)
#else
	##member.add()だけだと、戻り値のTrueが表示されてしまうためdammyにセットする
	#set($dammy = $member.add($record))
#end
#end
#foreach ($record in $member)
#draw_user($record)
#end
</ul>
#end
<img src="images/common/dot.gif" width="1" height="1" onload="if(aipo && aipo.customize){aipo.customize.addAutoHideMenuTrigger();aipo.customize.positionInitialize();}" style="display:none" />
